#!/usr/bin/env python3
"""
Monitor de Conex√£o WhatsApp W-API
Monitora status de conex√£o/desconex√£o e configura webhooks automaticamente
"""

import requests
import json
import time
import os
from datetime import datetime
from enum import Enum


class StatusConexao(Enum):
    CONECTADO = "conectado"
    DESCONECTADO = "desconectado"
    ERRO = "erro"
    DESCONHECIDO = "desconhecido"


class MonitorConexaoWAPI:
    def __init__(self, instance_id=None, bearer_token=None, webhook_id=None):
        self.instance_id = instance_id
        self.bearer_token = bearer_token
        self.webhook_id = webhook_id
        self.webhook_url = f"https://webhook.site/{webhook_id}" if webhook_id else None
        self.base_url = "https://api.w-api.app/v1"
        self.status_atual = StatusConexao.DESCONHECIDO
        self.ultimo_check = None
        self.ultimo_erro = None
        self.historico_conexao = []

    def testar_configuracao_basica(self):
        """Testa se a configura√ß√£o b√°sica est√° funcionando"""

        print("\nüß™ TESTANDO CONFIGURA√á√ÉO")
        print("=" * 30)

        # Teste 1: Verificar se a API responde
        try:
            url = "https://api.w-api.app/v1/instance/list"
            headers = {'Authorization': f'Bearer {self.bearer_token}'}

            print("üîç Testando conectividade com API...")
            response = requests.get(url, headers=headers, timeout=10)

            if response.status_code == 200:
                print("‚úÖ API respondendo normalmente")

                # Verificar se tem inst√¢ncias
                try:
                    data = response.json()
                    if not data.get('error', True):
                        instances = data.get('data', [])
                        print(f"üì± {len(instances)} inst√¢ncia(s) encontrada(s)")

                        # Verificar se nossa inst√¢ncia existe
                        nossa_instancia = None
                        for inst in instances:
                            if inst.get('instanceId') == self.instance_id:
                                nossa_instancia = inst
                                break

                        if nossa_instancia:
                            print(f"‚úÖ Inst√¢ncia {self.instance_id} encontrada")
                            print(f"üìä Status: {nossa_instancia}")
                        else:
                            print(f"‚ùå Inst√¢ncia {self.instance_id} N√ÉO encontrada")
                            print("üí° Verifique se o Instance ID est√° correto")
                    else:
                        print(f"‚ùå Erro na API: {data}")
                except:
                    print("‚ö†Ô∏è Resposta da API n√£o √© JSON v√°lido")

            elif response.status_code == 401:
                print("‚ùå Token de autoriza√ß√£o INV√ÅLIDO")
                print("üí° Verifique se o Bearer Token est√° correto")
                return False
            else:
                print(f"‚ùå API retornou erro: {response.status_code}")
                print(f"üìã Resposta: {response.text[:200]}")
                return False

        except requests.Timeout:
            print("‚ùå TIMEOUT na conex√£o com a API")
            print("üí° Verifique sua conex√£o com a internet")
            return False
        except requests.ConnectionError:
            print("‚ùå ERRO DE CONEX√ÉO com a API")
            print("üí° Verifique se a URL da API est√° correta")
            return False
        except Exception as e:
            print(f"‚ùå Erro inesperado: {e}")
            return False

        return True

    def carregar_configuracao(self):
        """Carrega configura√ß√£o de vari√°veis de ambiente ou solicita"""

        # Tentar vari√°veis de ambiente primeiro
        self.instance_id = self.instance_id or os.getenv('WAPI_INSTANCE_ID')
        self.bearer_token = self.bearer_token or os.getenv('WAPI_BEARER_TOKEN')
        self.webhook_id = self.webhook_id or os.getenv('WAPI_WEBHOOK_ID')

        # Se n√£o tem configura√ß√£o completa, solicitar
        if not all([self.instance_id, self.bearer_token, self.webhook_id]):
            print("üîß CONFIGURA√á√ÉO W-API")
            print("=" * 30)

            if not self.instance_id:
                self.instance_id = input("üì± Instance ID: ").strip()

            if not self.bearer_token:
                self.bearer_token = input("üîë Bearer Token: ").strip()

            if not self.webhook_id:
                webhook_input = input("üîó Webhook URL ou ID: ").strip()
                self.webhook_id = self.extrair_webhook_id(webhook_input)

        # Configurar URL do webhook
        if self.webhook_id:
            self.webhook_url = f"https://webhook.site/{self.webhook_id}"

        return all([self.instance_id, self.bearer_token, self.webhook_id])

    def extrair_webhook_id(self, webhook_input):
        """Extrai ID do webhook de URL ou retorna o pr√≥prio ID"""
        if not webhook_input:
            return None

        webhook_id = webhook_input.replace('https://webhook.site/', '')
        webhook_id = webhook_id.replace('http://webhook.site/', '')
        return webhook_id.strip()

    def configurar_webhook_conexao(self):
        """Configura webhook para eventos de conex√£o"""

        url = f"{self.base_url}/webhook/update-webhook-connected"
        headers = {
            'Content-Type': 'application/json',
            'Authorization': f'Bearer {self.bearer_token}'
        }
        params = {
            'instanceId': self.instance_id
        }
        data = {
            'value': self.webhook_url
        }

        try:
            response = requests.put(url, headers=headers, params=params, json=data)

            if response.status_code == 200:
                result = response.json()
                if not result.get('error', True):
                    print("‚úÖ Webhook de CONEX√ÉO configurado com sucesso!")
                    return True
                else:
                    print(f"‚ùå Erro ao configurar webhook de conex√£o: {result.get('message', 'Erro desconhecido')}")
                    return False
            else:
                print(f"‚ùå Erro HTTP ao configurar webhook de conex√£o: {response.status_code}")
                return False

        except Exception as e:
            print(f"‚ùå Erro ao configurar webhook de conex√£o: {e}")
            return False

    def configurar_webhook_desconexao(self):
        """Configura webhook para eventos de desconex√£o"""

        url = f"{self.base_url}/webhook/update-webhook-disconnected"
        headers = {
            'Content-Type': 'application/json',
            'Authorization': f'Bearer {self.bearer_token}'
        }
        params = {
            'instanceId': self.instance_id
        }
        data = {
            'value': self.webhook_url
        }

        try:
            response = requests.put(url, headers=headers, params=params, json=data)

            if response.status_code == 200:
                result = response.json()
                if not result.get('error', True):
                    print("‚úÖ Webhook de DESCONEX√ÉO configurado com sucesso!")
                    return True
                else:
                    print(f"‚ùå Erro ao configurar webhook de desconex√£o: {result.get('message', 'Erro desconhecido')}")
                    return False
            else:
                print(f"‚ùå Erro HTTP ao configurar webhook de desconex√£o: {response.status_code}")
                return False

        except Exception as e:
            print(f"‚ùå Erro ao configurar webhook de desconex√£o: {e}")
            return False

    def verificar_status_instancia(self):
        """Verifica o status atual da inst√¢ncia via API"""

        url = f"{self.base_url}/instance/status"
        headers = {
            'Authorization': f'Bearer {self.bearer_token}'
        }
        params = {
            'instanceId': self.instance_id
        }

        try:
            response = requests.get(url, headers=headers, params=params, timeout=15)

            print(f"üîç Debug API - Status Code: {response.status_code}")

            if response.status_code == 200:
                result = response.json()
                print(f"üîç Debug API - Response: {json.dumps(result, indent=2)}")

                # Interpretar resposta da API
                if not result.get('error', True):
                    status_info = result.get('data', {})
                    connected = status_info.get('connected', False)

                    if connected:
                        return StatusConexao.CONECTADO, status_info
                    else:
                        return StatusConexao.DESCONECTADO, status_info
                else:
                    return StatusConexao.ERRO, result
            elif response.status_code == 401:
                return StatusConexao.ERRO, {'error': 'Token de autoriza√ß√£o inv√°lido', 'code': 401}
            elif response.status_code == 404:
                return StatusConexao.ERRO, {'error': 'Inst√¢ncia n√£o encontrada', 'code': 404}
            else:
                try:
                    error_data = response.json()
                    return StatusConexao.ERRO, {'error': f'HTTP {response.status_code}', 'details': error_data}
                except:
                    return StatusConexao.ERRO, {'error': f'HTTP {response.status_code}', 'text': response.text[:200]}

        except requests.Timeout:
            return StatusConexao.ERRO, {'error': 'Timeout na conex√£o com a API'}
        except requests.ConnectionError:
            return StatusConexao.ERRO, {'error': 'Erro de conex√£o com a API'}
        except Exception as e:
            return StatusConexao.ERRO, {'error': str(e)}

    def buscar_eventos_webhook(self):
        """Busca eventos de conex√£o/desconex√£o no webhook"""

        try:
            url = f"https://webhook.site/token/{self.webhook_id}/requests"
            response = requests.get(url, timeout=10)

            if response.status_code == 200:
                data = response.json()
                eventos = []

                for request in data.get('data', []):
                    content = request.get('content')
                    timestamp = request.get('created_at')

                    if content:
                        try:
                            event_data = json.loads(content)

                            # Identificar tipo de evento
                            if self.eh_evento_conexao(event_data):
                                eventos.append({
                                    'tipo': 'conexao',
                                    'timestamp': timestamp,
                                    'data': event_data
                                })
                            elif self.eh_evento_desconexao(event_data):
                                eventos.append({
                                    'tipo': 'desconexao',
                                    'timestamp': timestamp,
                                    'data': event_data
                                })

                        except json.JSONDecodeError:
                            pass

                return eventos
            else:
                return []

        except Exception as e:
            print(f"‚ö†Ô∏è Erro ao buscar eventos do webhook: {e}")
            return []

    def eh_evento_conexao(self, data):
        """Verifica se √© evento de conex√£o"""
        return any([
            data.get('event') == 'connected',
            data.get('type') == 'connected',
            data.get('status') == 'connected',
            'connected' in str(data).lower() and 'true' in str(data).lower()
        ])

    def eh_evento_desconexao(self, data):
        """Verifica se √© evento de desconex√£o"""
        return any([
            data.get('event') == 'disconnected',
            data.get('type') == 'disconnected',
            data.get('status') == 'disconnected',
            'disconnect' in str(data).lower()
        ])

    def registrar_mudanca_status(self, novo_status, detalhes=None):
        """Registra mudan√ßa de status no hist√≥rico"""

        if novo_status != self.status_atual:
            mudanca = {
                'timestamp': datetime.now(),
                'status_anterior': self.status_atual.value,
                'status_novo': novo_status.value,
                'detalhes': detalhes
            }

            self.historico_conexao.append(mudanca)
            self.status_atual = novo_status

            # Exibir mudan√ßa
            self.exibir_mudanca_status(mudanca)

    def exibir_mudanca_status(self, mudanca):
        """Exibe mudan√ßa de status formatada"""

        timestamp = mudanca['timestamp'].strftime('%H:%M:%S')
        status_anterior = mudanca['status_anterior']
        status_novo = mudanca['status_novo']

        print('\n' + 'üîÑ' * 50)
        print(f'üì± MUDAN√áA DE STATUS - {timestamp}')
        print('üîÑ' * 50)

        # √çcones para status
        icones = {
            'conectado': 'üü¢',
            'desconectado': 'üî¥',
            'erro': '‚ùå',
            'desconhecido': '‚ö™'
        }

        print(f"{icones.get(status_anterior, '‚ö™')} DE: {status_anterior.upper()}")
        print(f"{icones.get(status_novo, '‚ö™')} PARA: {status_novo.upper()}")

        if mudanca.get('detalhes'):
            print(f"üìã Detalhes: {mudanca['detalhes']}")

        print('üîÑ' * 50 + '\n')

    def exibir_status_atual(self):
        """Exibe status atual formatado"""

        icones = {
            StatusConexao.CONECTADO: 'üü¢',
            StatusConexao.DESCONECTADO: 'üî¥',
            StatusConexao.ERRO: '‚ùå',
            StatusConexao.DESCONHECIDO: '‚ö™'
        }

        icone = icones.get(self.status_atual, '‚ö™')
        status_texto = self.status_atual.value.upper()

        print(f"\n{icone} STATUS: {status_texto}")

        if self.ultimo_check:
            tempo_check = self.ultimo_check.strftime('%H:%M:%S')
            print(f"üïê √öltima verifica√ß√£o: {tempo_check}")

    def monitorar_conexao(self, intervalo=30):
        """Monitora conex√£o em tempo real"""

        print(f"\nüöÄ MONITOR DE CONEX√ÉO INICIADO")
        print("=" * 40)
        print(f"üì± Inst√¢ncia: {self.instance_id}")
        print(f"üîó Webhook: {self.webhook_id}")
        print(f"‚è±Ô∏è Intervalo: {intervalo}s")
        print("üí° Pressione Ctrl+C para parar\n")

        try:
            while True:
                # Verificar status via API
                status, detalhes = self.verificar_status_instancia()
                self.ultimo_check = datetime.now()

                # Registrar mudan√ßa se houver
                self.registrar_mudanca_status(status, detalhes)

                # Exibir status atual
                self.exibir_status_atual()

                # Verificar eventos do webhook
                eventos = self.buscar_eventos_webhook()
                if eventos:
                    print(f"üì® {len(eventos)} eventos encontrados no webhook")

                time.sleep(intervalo)

        except KeyboardInterrupt:
            print(f"\nüëã MONITORAMENTO PARADO!")
            self.exibir_historico()

    def exibir_historico(self):
        """Exibe hist√≥rico de mudan√ßas"""

        if not self.historico_conexao:
            print("üìä Nenhuma mudan√ßa de status registrada.")
            return

        print(f"\nüìä HIST√ìRICO DE CONEX√ÉO ({len(self.historico_conexao)} mudan√ßas)")
        print("=" * 50)

        for i, mudanca in enumerate(self.historico_conexao[-10:], 1):  # √öltimas 10
            timestamp = mudanca['timestamp'].strftime('%H:%M:%S')
            status_novo = mudanca['status_novo']

            icones = {
                'conectado': 'üü¢',
                'desconectado': 'üî¥',
                'erro': '‚ùå',
                'desconhecido': '‚ö™'
            }

            icone = icones.get(status_novo, '‚ö™')
            print(f"{i:2}. {timestamp} - {icone} {status_novo.upper()}")

    def configurar_webhooks_completo(self):
        """Configura ambos os webhooks (conex√£o e desconex√£o)"""

        print("\nüîß CONFIGURANDO WEBHOOKS")
        print("=" * 30)

        sucesso_conexao = self.configurar_webhook_conexao()
        sucesso_desconexao = self.configurar_webhook_desconexao()

        if sucesso_conexao and sucesso_desconexao:
            print("\n‚úÖ Todos os webhooks configurados com sucesso!")
            return True
        else:
            print("\n‚ö†Ô∏è Alguns webhooks falharam na configura√ß√£o.")
            return False

    def executar(self):
        """Executa o monitor completo"""

        print("üîó MONITOR DE CONEX√ÉO W-API")
        print("=" * 40)

        # Carregar configura√ß√£o
        if not self.carregar_configuracao():
            print("‚ùå Configura√ß√£o incompleta!")
            return

        print(f"\n‚úÖ Configura√ß√£o carregada:")
        print(f"üì± Instance ID: {self.instance_id}")
        print(f"üîó Webhook: {self.webhook_url}")

        # Testar configura√ß√£o b√°sica primeiro
        if not self.testar_configuracao_basica():
            print("\n‚ùå Problemas na configura√ß√£o b√°sica!")
            print("üí° Corrija os problemas acima antes de continuar")
            return

        # Configurar webhooks
        if self.configurar_webhooks_completo():
            # Verificar status inicial
            status, detalhes = self.verificar_status_instancia()
            self.registrar_mudanca_status(status, detalhes)
            self.ultimo_check = datetime.now()

            print(f"\nüìä Status inicial:")
            self.exibir_status_atual()

            # Se h√° erro no status inicial, explicar poss√≠veis causas
            if status == StatusConexao.ERRO:
                print("\nüîç POSS√çVEIS CAUSAS DO ERRO:")
                print("1. üì± WhatsApp n√£o est√° conectado (precisa escanear QR Code)")
                print("2. üîÑ Inst√¢ncia foi pausada ou desativada")
                print("3. ‚è±Ô∏è Timeout de inatividade")
                print("4. üîß Problemas de configura√ß√£o na W-API")
                print("5. üåê Problemas de conectividade")

            # Perguntar se quer monitorar continuamente
            continuar = input("\n‚ùì Iniciar monitoramento cont√≠nuo? (s/n): ").lower()

            if continuar.startswith('s') or continuar == '':
                self.monitorar_conexao()
        else:
            print("‚ùå Falha na configura√ß√£o dos webhooks!")


def main():
    """Fun√ß√£o principal"""

    # Voc√™ pode definir valores padr√£o aqui
    monitor = MonitorConexaoWAPI()
    monitor.executar()


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print("\nüëã Monitor encerrado!")
    except Exception as e:
        print(f"\n‚ùå Erro: {e}")

# ========================================
# CONFIGURA√á√ÉO VIA VARI√ÅVEIS DE AMBIENTE:
# ========================================
#
# export WAPI_INSTANCE_ID=sua_instancia
# export WAPI_BEARER_TOKEN=seu_token
# export WAPI_WEBHOOK_ID=seu_webhook_id
# python monitor_conexao.py
#
# ========================================